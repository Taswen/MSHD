name: GitHub Actions Demo
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  IMAGE_NAME: mshd
  SC_IMAGE_NAME: mshd-sc
  DOCKER_ACCOUNT: chivalryq

jobs:
  build-image:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2

      - name: Build web image
        run: docker build . --file Dockerfile --tag $IMAGE_NAME

      - name: Build scanner image
        run: docker build . --file Dockerfile.sc --tag $SC_IMAGE_NAME

      - name: Log into registry
        run: echo "${{ secrets.DOCKER_ACCESS }}" | docker login -u $DOCKER_ACCOUNT --password-stdin

      - name: Push image
        run: |
          IMAGE_ID=$DOCKER_ACCOUNT/$IMAGE_NAME
          SC_IMAGE_ID=$DOCKER_ACCOUNT/$SC_IMAGE_NAME
          VERSION=latest

          echo IMAGE_ID=$IMAGE_ID
          echo SC_IMAGE_ID=$SC_IMAGE_ID
          echo VERSION=$VERSION

          docker tag $IMAGE_NAME $IMAGE_ID:$VERSION
          docker tag $SC_IMAGE_NAME $SC_IMAGE_ID:$VERSION

          docker push $IMAGE_ID:$VERSION
          docker push $SC_IMAGE_ID:$VERSION


  deploy-web:
    needs: [ build-image ]
    name: Deploy Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }} # 服务器ip
          username: root
          password: ${{ secrets.HOST_PASSWORD }} # 服务器登录密码
          port: 22
          script: |
            ftp_dir=/var/ftp/data
            docker stop $(docker ps -q)
            docker rm -f $(docker ps -a -q)
            docker rmi -f $(docker images -q)
            docker pull chivalryq/mshd-sc:latest
            docker pull chivalryq/mshd:latest
            docker run -d -v $ftp_dir/upload:/upload -v $ftp_dir/scanned:/scanned -v $ftp_dir/error:/error -p 80:80  chivalryq/mshd:latest
            docker run -d -v $ftp_dir/upload:/upload -v $ftp_dir/scanned:/scanned -v $ftp_dir/error:/error chivalryq/mshd-sc:latest